name: CD

on:
  push:
    branches:
      - main

jobs:
  release-and-docker:
    runs-on: ubuntu-latest

    permissions:
      contents: write      # For semantic-release to push changes
      packages: write      # For pushing to GitHub Container Registry
      pull-requests: read
      statuses: write

    environment: PROD

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Install OC CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -o oc.tar.gz
          tar -xvf oc.tar.gz
          sudo mv oc /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Select project
        run: |
          oc project ${{ secrets.OPENSHIFT_NAMESPACE }}

      - name: Check deployment exists
        run: |
          oc get deployment entregable-mdsci -o yaml

      - name: Update deployment to latest image
        run: |
          REPO_LOWER=$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')
          oc set image deployment/entregable-mdsci \
            entregable-mdsci=ghcr.io/${REPO_LOWER}:latest

      - name: Ensure replicas >= 1
        run: |
          CURRENT=$(oc get deployment entregable-mdsci -o jsonpath='{.spec.replicas}')
          if [ "$CURRENT" -eq 0 ]; then
            oc scale deployment entregable-mdsci --replicas=1
          fi

      - name: Force rollout
        run: |
          oc rollout restart deployment/entregable-mdsci

      - name: Wait for pod to be ready
        run: |
          oc rollout status deployment/entregable-mdsci --timeout=120s

      - name: Show logs of new pod
        run: |
          POD=$(oc get pods -l deployment=entregable-mdsci -o jsonpath='{.items[0].metadata.name}')
          oc logs $POD

      - name: Run e2e tests
        env:
          SERVER_URL: ${{ vars.PROD_SERVER_URL }}
        run: |
          sleep 10
          echo "Running e2e tests against server URL: '${SERVER_URL}'"
          npm test -- tests/e2e/