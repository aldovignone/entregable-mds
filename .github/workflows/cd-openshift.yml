name: CD-OPENSHIFT

on:
  workflow_dispatch:

jobs:
  test-openshift:
    runs-on: ubuntu-latest

    steps:
      - name: Install OC CLI
        run: |
          curl -L https://mirror.openshift.com/pub/openshift-v4/clients/ocp/latest/openshift-client-linux.tar.gz -o oc.tar.gz
          tar -xvf oc.tar.gz
          sudo mv oc /usr/local/bin/

      - name: Login to OpenShift
        run: |
          oc login ${{ secrets.OPENSHIFT_SERVER }} \
            --token=${{ secrets.OPENSHIFT_TOKEN }} \
            --insecure-skip-tls-verify=true

      - name: Select project
        run: |
          oc project ${{ secrets.OPENSHIFT_NAMESPACE }}

      - name: Check deployment exists
        run: |
          oc get deployment entregable-mdsci -o yaml

      - name: Update deployment to latest image
        run: |
          REPO_LOWER=$(echo $GITHUB_REPOSITORY | tr '[:upper:]' '[:lower:]')
          oc set image deployment/entregable-mdsci \
            entregable-mdsci=ghcr.io/${REPO_LOWER}:latest

      - name: Ensure replicas >= 1
        run: |
          CURRENT=$(oc get deployment entregable-mdsci -o jsonpath='{.spec.replicas}')
          if [ "$CURRENT" -eq 0 ]; then
            oc scale deployment entregable-mdsci --replicas=1
          fi

      - name: Force rollout
        run: |
          oc rollout restart deployment/entregable-mdsci

      - name: Wait for pod to be ready
        run: |
          oc rollout status deployment/entregable-mdsci --timeout=120s

      - name: Show logs of new pod
        run: |
          POD=$(oc get pods -l deployment=entregable-mdsci -o jsonpath='{.items[0].metadata.name}')
          oc logs $POD